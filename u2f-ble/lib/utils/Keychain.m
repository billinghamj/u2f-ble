//
//  Keychain.m
//  u2f-ble-test-ios
//
//  Created by Nicolas Bigot on 17/05/2016.
//  Copyright Â© 2016 Ledger. All rights reserved.
//

@import Foundation;
@import Security;

NSData *getPublicKeyBitsFromKey(SecKeyRef givenKey) {
	static const uint8_t publicKeyIdentifier[] = "co.ledger.u2f-ble-test";
	NSData *publicTag = [[NSData alloc] initWithBytes:publicKeyIdentifier length:sizeof(publicKeyIdentifier)];

	OSStatus sanityCheck = noErr;
	NSData * publicKeyBits = nil;

	NSMutableDictionary * queryPublicKey = [[NSMutableDictionary alloc] init];
	[queryPublicKey setObject:(__bridge id)kSecClassKey forKey:(__bridge id)kSecClass];
	[queryPublicKey setObject:publicTag forKey:(__bridge id)kSecAttrApplicationTag];
	[queryPublicKey setObject:(__bridge id)kSecAttrKeyTypeRSA forKey:(__bridge id)kSecAttrKeyType];

	// Temporarily add key to the Keychain, return as data:
	NSMutableDictionary * attributes = [queryPublicKey mutableCopy];
	[attributes setObject:(__bridge id)givenKey forKey:(__bridge id)kSecValueRef];
	[attributes setObject:@YES forKey:(__bridge id)kSecReturnData];
	CFTypeRef result;
	sanityCheck = SecItemAdd((__bridge CFDictionaryRef) attributes, &result);
	if (sanityCheck == errSecSuccess) {
		publicKeyBits = CFBridgingRelease(result);

		// Remove from Keychain again:
		(void)SecItemDelete((__bridge CFDictionaryRef) queryPublicKey);
	}

	return publicKeyBits;
}
